import React, { useState } from 'react';
import { useSelector } from 'react-redux';
import { useNavigate, useParams } from 'react-router-dom';
import { setCurrentReport } from '../store/slices/reportSlice';
import { generateReport } from '../store/reportSlice';
import { RootState } from '../store';
import { HostInfo, PortInfo, Vulnerability } from '../types';
import { useAppDispatch } from '../store/hooks';
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from '../components/ui/card';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Alert, AlertTitle, AlertDescription } from '../components/ui/alert';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "../components/ui/accordion";
import { ChevronDown } from 'lucide-react';

const VulnerabilityResults: React.FC = () => {
  const dispatch = useAppDispatch();
  const navigate = useNavigate();
  const { scanId } = useParams<{ scanId: string }>();
  const { currentVulnerability, loading } = useSelector((state: RootState) => state.vulnerability);
  const [isGeneratingReport, setIsGeneratingReport] = useState(false);
  const [reportError, setReportError] = useState<string | null>(null);
  
  if (!currentVulnerability) {
    return (
      <Card className="mt-8">
        <CardHeader>
          <CardTitle>ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="p-4 border rounded bg-secondary text-secondary-foreground">
            ì·¨ì•½ì  ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì´ê±°ë‚˜ ì‚¬ìš© ê°€ëŠ¥í•œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </CardContent>
      </Card>
    );
  }
  
  // ë¦¬í¬íŠ¸ ìƒì„± í•¨ìˆ˜
  const handleGenerateReport = async () => {
    if (!scanId) {
      setReportError('ìŠ¤ìº” IDê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    setIsGeneratingReport(true);
    setReportError(null);
    
    try {
      console.log('ë¦¬í¬íŠ¸ ìƒì„± ìš”ì²­ ì‹œì‘...', { scanId });
      
      // Redux ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë¦¬í¬íŠ¸ ìƒì„±
      const result = await dispatch(generateReport(scanId)).unwrap();
      
      console.log('ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ:', result);
      
      // ë¦¬í¬íŠ¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
      if (result && result.report_id) {
        // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì„ì‹œë¡œ ë¦¬í¬íŠ¸ ë°ì´í„° ì €ì¥ (ì¤‘ë³µ ë³´í—˜)
        sessionStorage.setItem('current_report', JSON.stringify(result));
        navigate(`/reports/${result.report_id}`);
      } else {
        console.error('ë¦¬í¬íŠ¸ IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', result);
        setReportError('ë¦¬í¬íŠ¸ IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì‘ë‹µì— report_idê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
    } catch (error: any) {
      console.error('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
      setReportError(error?.message || 'ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsGeneratingReport(false);
    }
  };
  
  // ì·¨ì•½ì ì´ ìˆëŠ” í˜¸ìŠ¤íŠ¸/í¬íŠ¸ì˜ ìˆ˜ ê³„ì‚°
  const vulnerableHosts = currentVulnerability.hosts.filter((host: HostInfo) => 
    host.ports.some((port: PortInfo) => port.vulnerabilities && port.vulnerabilities.length > 0)
  );
  
  const totalVulnerabilities = currentVulnerability.hosts.reduce((total: number, host: HostInfo) => {
    return total + host.ports.reduce((portTotal: number, port: PortInfo) => {
      return portTotal + (port.vulnerabilities?.length || 0);
    }, 0);
  }, 0);
  
  // CVSS ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì •
  const getCvssSeverity = (score: number) => {
    if (score >= 9) return 'destructive';
    if (score >= 7) return 'destructive';
    if (score >= 4) return 'warning';
    return 'success';
  };
  
  // ì„œë¹„ìŠ¤ íƒ€ì…ì— ë”°ë¼ ì•„ì´ì½˜ ë°˜í™˜
  const getServiceIcon = (service?: string) => {
    if (!service) return 'ğŸ”Œ';
    
    switch (service.toLowerCase()) {
      case 'http': case 'https': return 'ğŸŒ';
      case 'ssh': return 'ğŸ”’';
      case 'ftp': return 'ğŸ“';
      case 'smtp': case 'pop3': case 'imap': return 'âœ‰ï¸';
      case 'dns': return 'ğŸ”';
      case 'mysql': case 'postgresql': case 'oracle': case 'mssql': return 'ğŸ—„ï¸';
      case 'telnet': return 'ğŸ“º';
      case 'rdp': return 'ğŸ–¥ï¸';
      default: return 'ğŸ”Œ';
    }
  };
  
  // ìŠ¤í¬ë¦½íŠ¸ IDì— ë”°ë¼ ì‚¬ìš©ì ì¹œí™”ì  ì œëª© ë°˜í™˜
  const getScriptTitle = (id?: string) => {
    if (!id) return 'ì •ë³´';
    
    switch (id) {
      case 'http-title': return 'í˜ì´ì§€ ì œëª©';
      case 'http-robots.txt': return 'ë¡œë´‡ ë°°ì œ í‘œì¤€';
      case 'http-server-header': return 'ì›¹ ì„œë²„ ì •ë³´';
      case 'http-methods': return 'ì§€ì› HTTP ë©”ì†Œë“œ';
      case 'ssl-cert': return 'SSL ì¸ì¦ì„œ';
      case 'ssh-hostkey': return 'SSH í˜¸ìŠ¤íŠ¸ í‚¤';
      case 'banner': return 'ì„œë¹„ìŠ¤ ë°°ë„ˆ';
      default: return id;
    }
  };
  
  // ìŠ¤í¬ë¦½íŠ¸ íƒ€ì…ì— ë”°ë¼ ë°°ê²½ìƒ‰ ì§€ì •
  const getScriptBackground = (id?: string) => {
    if (!id) return '';
    
    if (id.startsWith('http-')) return 'bg-blue-50/30';
    if (id.startsWith('ssl-')) return 'bg-green-50/30';
    if (id.startsWith('ssh-')) return 'bg-yellow-50/30';
    if (id.startsWith('ftp-')) return 'bg-purple-50/30';
    return '';
  };
  
  // ì·¨ì•½ì ì˜ ì‹¬ê°ë„ì— ë”°ë¥¸ ë°°ì§€ ìƒ‰ìƒ
  const getSeverityColor = (score: number) => {
    if (score >= 9) return 'bg-red-500 text-white';
    if (score >= 7) return 'bg-orange-500 text-white';
    if (score >= 4) return 'bg-yellow-500 text-black';
    return 'bg-green-500 text-white';
  };
  
  return (
    <Card className="mt-8">
      <CardHeader>
        <CardTitle>ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼</CardTitle>
      </CardHeader>
      
      <CardContent>
        {reportError && (
          <Alert variant="destructive" className="mb-4">
            <AlertTitle>ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜</AlertTitle>
            <AlertDescription>{reportError}</AlertDescription>
          </Alert>
        )}
        
        <div className="mb-6 grid grid-cols-2 gap-4">
          <div className="p-4 bg-secondary/50 rounded">
            <div className="text-2xl font-bold">{vulnerableHosts.length}</div>
            <div className="text-sm text-muted-foreground">ì·¨ì•½í•œ í˜¸ìŠ¤íŠ¸</div>
          </div>
          <div className="p-4 bg-secondary/50 rounded">
            <div className="text-2xl font-bold">{totalVulnerabilities}</div>
            <div className="text-sm text-muted-foreground">ë°œê²¬ëœ ì·¨ì•½ì </div>
          </div>
        </div>
        
        {currentVulnerability.hosts.map((host: HostInfo, index: number) => {
          // ì·¨ì•½ì ì´ ìˆëŠ” í¬íŠ¸ë§Œ í•„í„°ë§
          const vulnerablePorts = host.ports.filter((port: PortInfo) => 
            port.vulnerabilities && port.vulnerabilities.length > 0
          );
          
          if (vulnerablePorts.length === 0) return null;
          
          return (
            <div key={index} className="mb-6 border-b pb-4">
              <h3 className="text-lg font-medium">{host.host}</h3>
              
              {vulnerablePorts.map((port: PortInfo, portIndex: number) => (
                <div key={portIndex} className="mb-5">
                  <h4 className="text-md font-medium mt-3 mb-2">
                    {port.port}/{port.service} - {port.product} {port.version}
                  </h4>
                  
                  {/* ì„œë¹„ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì •ë³´ ì„¹ì…˜ ì¶”ê°€ */}
                  {port.scripts && port.scripts.length > 0 && (
                    <div className="mb-4 bg-muted/20 p-3 rounded">
                      <div className="text-sm font-medium mb-2">{getServiceIcon(port.service)} ì„œë¹„ìŠ¤ ì •ë³´</div>
                      <div className="grid grid-cols-1 gap-2">
                        {port.scripts.map((script: any, scriptIndex: number) => (
                          <div key={scriptIndex} className={`text-sm p-2 rounded border ${getScriptBackground(script.id)}`}>
                            <div className="font-medium text-xs mb-1">{getScriptTitle(script.id)}</div>
                            <div className="whitespace-pre-wrap text-muted-foreground text-xs max-h-[150px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100">{script.output}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* ì·¨ì•½ì  ì •ë³´ë¥¼ ì•„ì½”ë””ì–¸(ë“œë¡­ë‹¤ìš´) í˜•ì‹ìœ¼ë¡œ í‘œì‹œ */}
                  {port.vulnerabilities && port.vulnerabilities.length > 0 && (
                    <div className="mb-3">
                      <h5 className="text-sm font-medium mb-2">ë°œê²¬ëœ ì·¨ì•½ì  ({port.vulnerabilities.length}ê°œ)</h5>
                      <div className="max-h-[400px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100 pr-1 border rounded-md">
                        <Accordion type="single" collapsible className="w-full">
                          {port.vulnerabilities.map((vuln: Vulnerability, vulnIndex: number) => (
                            <AccordionItem key={vulnIndex} value={`vuln-${portIndex}-${vulnIndex}`} className="border-b last:border-b-0 overflow-hidden">
                              <AccordionTrigger className="px-3 py-2 hover:no-underline hover:bg-muted/30">
                                <div className="flex items-center justify-between w-full">
                                  <div className="font-medium text-sm whitespace-nowrap mr-2">{vuln.cve_id}</div>
                                  <div className="text-xs text-blue-500 underline px-2 flex-1">
                                    <a href={`https://vulners.com/cve/${vuln.cve_id}`} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()}>
                                      https://vulners.com/cve/{vuln.cve_id}
                                    </a>
                                  </div>
                                  <Badge variant={getCvssSeverity(vuln.cvss_score)} className="ml-2">
                                    CVSS: {vuln.cvss_score.toFixed(1)}
                                  </Badge>
                                </div>
                              </AccordionTrigger>
                              <AccordionContent className="px-3 py-2 bg-muted/10">
                                <div className="font-medium text-sm mb-1">{vuln.title}</div>
                                <div className="text-xs text-muted-foreground max-h-[200px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100">{vuln.description}</div>
                              </AccordionContent>
                            </AccordionItem>
                          ))}
                        </Accordion>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          );
        })}
      </CardContent>
      
      <CardFooter>
        <Button 
          className="w-full" 
          onClick={handleGenerateReport} 
          disabled={loading || isGeneratingReport}
        >
          {isGeneratingReport ? 'ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...' : 'ë¦¬í¬íŠ¸ ìƒì„±'}
        </Button>
      </CardFooter>
    </Card>
  );
};

export default VulnerabilityResults; 