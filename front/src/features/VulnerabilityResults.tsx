import React, { useState, useMemo, useCallback } from 'react';
import { useSelector } from 'react-redux';
import { useNavigate, useParams } from 'react-router-dom';
import { setCurrentReport } from '../store/slices/reportSlice';
import { generateReport } from '../store/slices/reportSlice';
import { RootState } from '../store';
import { HostInfo, PortInfo, Vulnerability } from '../types';
import { useAppDispatch } from '../store/hooks';
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from '../components/ui/card';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Alert, AlertTitle, AlertDescription } from '../components/ui/alert';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "../components/ui/accordion";
import { ChevronDown } from 'lucide-react';
import NetworkTopology from './NetworkTopology';

// ìµœëŒ€ í‘œì‹œí•  ì·¨ì•½ì  ìˆ˜ ì œí•œ
const MAX_VULNERABILITIES_PER_PORT = 50;

const VulnerabilityResults: React.FC = () => {
  const dispatch = useAppDispatch();
  const navigate = useNavigate();
  const { scanId } = useParams<{ scanId: string }>();
  const { currentVulnerability, loading } = useSelector((state: RootState) => state.vulnerability);
  const { currentReport } = useSelector((state: RootState) => state.report);
  const [isGeneratingReport, setIsGeneratingReport] = useState(false);
  const [reportError, setReportError] = useState<string | null>(null);
  const [expandedHosts, setExpandedHosts] = useState<Record<string, boolean>>({});
  
  // í˜¸ìŠ¤íŠ¸ í‘œì‹œ í† ê¸€ ìƒíƒœ ê´€ë¦¬
  const toggleHost = useCallback((hostId: string) => {
    setExpandedHosts(prev => ({
      ...prev,
      [hostId]: !prev[hostId]
    }));
  }, []);
  
  // ë©”ëª¨ì œì´ì…˜ëœ ê³„ì‚° - ë©”ëª¨ë¦¬ ìµœì í™”
  // currentVulnerabilityê°€ nullì¼ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
  const { vulnerableHosts, totalVulnerabilities } = useMemo(() => {
    if (!currentVulnerability) {
      return { vulnerableHosts: [], totalVulnerabilities: 0 };
    }
    
    // ì·¨ì•½ì ì´ ìˆëŠ” í˜¸ìŠ¤íŠ¸ë§Œ í•„í„°ë§
    const hosts = currentVulnerability.hosts.filter((host: HostInfo) => 
      host.ports.some((port: PortInfo) => port.vulnerabilities && port.vulnerabilities.length > 0)
    );
    
    // ì „ì²´ ì·¨ì•½ì  ìˆ˜ ê³„ì‚°
    const total = hosts.reduce((total: number, host: HostInfo) => {
      return total + host.ports.reduce((portTotal: number, port: PortInfo) => {
        return portTotal + (port.vulnerabilities?.length || 0);
      }, 0);
    }, 0);
    
    return {
      vulnerableHosts: hosts,
      totalVulnerabilities: total
    };
  }, [currentVulnerability]);
  
  if (!currentVulnerability) {
    return (
      <Card className="mt-8">
        <CardHeader>
          <CardTitle>ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="p-4 border rounded bg-secondary text-secondary-foreground">
            ì·¨ì•½ì  ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì´ê±°ë‚˜ ì‚¬ìš© ê°€ëŠ¥í•œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </CardContent>
      </Card>
    );
  }
  
  // ë¦¬í¬íŠ¸ ìƒì„± í•¨ìˆ˜
  const handleGenerateReport = async () => {
    if (!scanId) {
      setReportError('ìŠ¤ìº” IDê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    setIsGeneratingReport(true);
    setReportError(null);
    
    try {
      console.log('ë¦¬í¬íŠ¸ ìƒì„± ìš”ì²­ ì‹œì‘...', { scanId });
      
      // ë©”ëª¨ë¦¬ ìµœì í™”: ì·¨ì•½ì  ë°ì´í„°ë¥¼ ì§ì ‘ ì „ë‹¬í•˜ì§€ ì•Šê³  ìŠ¤ìº” IDë§Œ ì „ë‹¬
      const result = await dispatch(generateReport(scanId)).unwrap();
      
      console.log('ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ:', result);
      
      // ë¦¬í¬íŠ¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
      if (result && result.report_id) {
        // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„° ì €ì¥í•˜ì§€ ì•Šê³  IDë§Œ ì‚¬ìš©í•˜ì—¬ ë¼ìš°íŒ… ì²˜ë¦¬
        // sessionStorage.setItem('current_report', JSON.stringify(result)); // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ ì›ì¸
        navigate(`/reports/${result.report_id}`);
      } else {
        console.error('ë¦¬í¬íŠ¸ IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', result);
        setReportError('ë¦¬í¬íŠ¸ IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì‘ë‹µì— report_idê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
    } catch (error: any) {
      console.error('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
      setReportError(error?.message || 'ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsGeneratingReport(false);
    }
  };
  
  // CVSS ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì •
  const getCvssSeverity = (score: number) => {
    if (score >= 9) return 'destructive';
    if (score >= 7) return 'destructive';
    if (score >= 4) return 'warning';
    return 'success';
  };
  
  // ì„œë¹„ìŠ¤ íƒ€ì…ì— ë”°ë¼ ì•„ì´ì½˜ ë°˜í™˜
  const getServiceIcon = (service?: string) => {
    if (!service) return 'ğŸ”Œ';
    
    switch (service.toLowerCase()) {
      case 'http': case 'https': return 'ğŸŒ';
      case 'ssh': return 'ğŸ”’';
      case 'ftp': return 'ğŸ“';
      case 'smtp': case 'pop3': case 'imap': return 'âœ‰ï¸';
      case 'dns': return 'ğŸ”';
      case 'mysql': case 'postgresql': case 'oracle': case 'mssql': return 'ğŸ—„ï¸';
      case 'telnet': return 'ğŸ“º';
      case 'rdp': return 'ğŸ–¥ï¸';
      default: return 'ğŸ”Œ';
    }
  };
  
  // ìŠ¤í¬ë¦½íŠ¸ IDì— ë”°ë¼ ì‚¬ìš©ì ì¹œí™”ì  ì œëª© ë°˜í™˜
  const getScriptTitle = (id?: string) => {
    if (!id) return 'ì •ë³´';
    
    switch (id) {
      case 'http-title': return 'í˜ì´ì§€ ì œëª©';
      case 'http-robots.txt': return 'ë¡œë´‡ ë°°ì œ í‘œì¤€';
      case 'http-server-header': return 'ì›¹ ì„œë²„ ì •ë³´';
      case 'http-methods': return 'ì§€ì› HTTP ë©”ì†Œë“œ';
      case 'ssl-cert': return 'SSL ì¸ì¦ì„œ';
      case 'ssh-hostkey': return 'SSH í˜¸ìŠ¤íŠ¸ í‚¤';
      case 'banner': return 'ì„œë¹„ìŠ¤ ë°°ë„ˆ';
      default: return id;
    }
  };
  
  // ìŠ¤í¬ë¦½íŠ¸ íƒ€ì…ì— ë”°ë¼ ë°°ê²½ìƒ‰ ì§€ì •
  const getScriptBackground = (id?: string) => {
    if (!id) return '';
    
    if (id.startsWith('http-')) return 'bg-blue-50/30';
    if (id.startsWith('ssl-')) return 'bg-green-50/30';
    if (id.startsWith('ssh-')) return 'bg-yellow-50/30';
    if (id.startsWith('ftp-')) return 'bg-purple-50/30';
    return '';
  };
  
  return (
    <>
      <Card className="mt-8">
        <CardHeader>
          <CardTitle>ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼</CardTitle>
        </CardHeader>
        
        <CardContent>
          {reportError && (
            <Alert variant="destructive" className="mb-4">
              <AlertTitle>ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜</AlertTitle>
              <AlertDescription>{reportError}</AlertDescription>
            </Alert>
          )}
          
          <div className="mb-6 grid grid-cols-2 gap-4">
            <div className="p-4 bg-secondary/50 rounded">
              <div className="text-2xl font-bold">{vulnerableHosts.length}</div>
              <div className="text-sm text-muted-foreground">ì·¨ì•½í•œ í˜¸ìŠ¤íŠ¸</div>
            </div>
            <div className="p-4 bg-secondary/50 rounded">
              <div className="text-2xl font-bold">{totalVulnerabilities}</div>
              <div className="text-sm text-muted-foreground">ë°œê²¬ëœ ì·¨ì•½ì </div>
            </div>
          </div>
          
          {/* í˜¸ìŠ¤íŠ¸ ëª©ë¡ - ì•„ì½”ë””ì–¸ í˜•ì‹ìœ¼ë¡œ í‘œì‹œí•´ì„œ ë©”ëª¨ë¦¬ ì‚¬ìš© ìµœì í™” */}
          <Accordion type="multiple" className="w-full">
            {currentVulnerability.hosts.map((host: HostInfo, index: number) => {
              // ì·¨ì•½ì ì´ ìˆëŠ” í¬íŠ¸ë§Œ í•„í„°ë§
              const vulnerablePorts = host.ports.filter((port: PortInfo) => 
                port.vulnerabilities && port.vulnerabilities.length > 0
              );
              
              if (vulnerablePorts.length === 0) return null;
              
              // í˜¸ìŠ¤íŠ¸ë³„ ì´ ì·¨ì•½ì  ìˆ˜
              const hostVulnCount = vulnerablePorts.reduce((count, port) => 
                count + (port.vulnerabilities?.length || 0), 0
              );
              
              // í˜¸ìŠ¤íŠ¸ë³„ ê³ ìœ„í—˜ ì·¨ì•½ì  ìˆ˜
              const hostHighRiskCount = vulnerablePorts.reduce((count, port) => {
                if (!port.vulnerabilities) return count;
                return count + port.vulnerabilities.filter(v => v.cvss_score >= 7.0).length;
              }, 0);
              
              return (
                <AccordionItem key={`host-${index}`} value={`host-${index}`} className="border-b last:border-b-0">
                  <AccordionTrigger className="px-4 py-2 hover:no-underline hover:bg-muted/30">
                    <div className="flex items-center justify-between w-full">
                      <div className="font-medium">{host.host}</div>
                      <div className="text-sm">
                        {hostVulnCount}ê°œ ì·¨ì•½ì 
                        {hostHighRiskCount > 0 && (
                          <Badge variant="destructive" className="ml-2">
                            ê³ ìœ„í—˜: {hostHighRiskCount}
                          </Badge>
                        )}
                      </div>
                    </div>
                  </AccordionTrigger>
                  <AccordionContent>
                    <div className="px-4 py-2">
                      {/* í¬íŠ¸ ì •ë³´ */}
                      {vulnerablePorts.map((port: PortInfo, portIndex: number) => (
                        <div key={`port-${index}-${portIndex}`} className="mb-5 border-b pb-4 last:border-b-0">
                          <h4 className="text-md font-medium mt-2 mb-2">
                            {port.port_id}/{port.service} - {port.version || ''}
                          </h4>
                          
                          {/* ì„œë¹„ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì •ë³´ ì„¹ì…˜ - ìµœì†Œí•œìœ¼ë¡œ í‘œì‹œ */}
                          {port.scripts && port.scripts.length > 0 && (
                            <div className="mb-4 bg-muted/20 p-3 rounded">
                              <div className="text-sm font-medium mb-2">{getServiceIcon(port.service)} ì„œë¹„ìŠ¤ ì •ë³´</div>
                              <div className="grid grid-cols-1 gap-2">
                                {/* ì²« 3ê°œ ìŠ¤í¬ë¦½íŠ¸ë§Œ í‘œì‹œ */}
                                {port.scripts.slice(0, 3).map((script: any, scriptIndex: number) => (
                                  <div key={scriptIndex} className={`text-sm p-2 rounded border ${getScriptBackground(script.id)}`}>
                                    <div className="font-medium text-xs mb-1">{getScriptTitle(script.id)}</div>
                                    <div className="whitespace-pre-wrap text-muted-foreground text-xs max-h-[100px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100">
                                      {/* ìŠ¤í¬ë¦½íŠ¸ ì¶œë ¥ì´ ë„ˆë¬´ ê¸¸ë©´ ì¼ë¶€ë§Œ í‘œì‹œ */}
                                      {script.output.length > 300 ? `${script.output.substring(0, 300)}...` : script.output}
                                    </div>
                                  </div>
                                ))}
                                {port.scripts.length > 3 && (
                                  <div className="text-xs text-muted-foreground">
                                    ì™¸ {port.scripts.length - 3}ê°œ ìŠ¤í¬ë¦½íŠ¸ ì •ë³´ê°€ ë” ìˆìŠµë‹ˆë‹¤.
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                          
                          {/* ì·¨ì•½ì  ì •ë³´ë¥¼ ì•„ì½”ë””ì–¸(ë“œë¡­ë‹¤ìš´) í˜•ì‹ìœ¼ë¡œ í‘œì‹œ - í˜ì´ì§€ë„¤ì´ì…˜ ì ìš© */}
                          {port.vulnerabilities && port.vulnerabilities.length > 0 && (
                            <div className="mb-3">
                              <h5 className="text-sm font-medium mb-2">ë°œê²¬ëœ ì·¨ì•½ì  ({port.vulnerabilities.length}ê°œ)</h5>
                              <div className="max-h-[350px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100 pr-1 border rounded-md">
                                <Accordion type="single" collapsible className="w-full">
                                  {/* ì·¨ì•½ì  ë°ì´í„° ì œí•œí•˜ì—¬ ë Œë”ë§ */}
                                  {port.vulnerabilities.slice(0, MAX_VULNERABILITIES_PER_PORT).map((vuln: Vulnerability, vulnIndex: number) => (
                                    <AccordionItem key={vulnIndex} value={`vuln-${portIndex}-${vulnIndex}`} className="border-b last:border-b-0 overflow-hidden">
                                      <AccordionTrigger className="px-3 py-2 hover:no-underline hover:bg-muted/30">
                                        <div className="flex items-center justify-between w-full">
                                          <div className="font-medium text-sm whitespace-nowrap mr-2">{vuln.cve_id}</div>
                                          <div className="text-xs text-blue-500 underline px-2 flex-1">
                                            <a href={`https://vulners.com/cve/${vuln.cve_id}`} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()}>
                                              https://vulners.com/cve/{vuln.cve_id}
                                            </a>
                                          </div>
                                          <Badge variant={getCvssSeverity(vuln.cvss_score)} className="ml-2">
                                            CVSS: {vuln.cvss_score.toFixed(1)}
                                          </Badge>
                                        </div>
                                      </AccordionTrigger>
                                      <AccordionContent className="px-3 py-2 bg-muted/10">
                                        <div className="font-medium text-sm mb-1">{vuln.title}</div>
                                        <div className="text-xs text-muted-foreground max-h-[100px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100">
                                          {/* ì„¤ëª…ì´ ë„ˆë¬´ ê¸¸ë©´ ì¼ë¶€ë§Œ í‘œì‹œ */}
                                          {vuln.description.length > 500 ? `${vuln.description.substring(0, 500)}...` : vuln.description}
                                        </div>
                                      </AccordionContent>
                                    </AccordionItem>
                                  ))}
                                  {/* í‘œì‹œ ì œí•œì„ ì´ˆê³¼í•˜ëŠ” ì·¨ì•½ì ì´ ìˆìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ */}
                                  {port.vulnerabilities.length > MAX_VULNERABILITIES_PER_PORT && (
                                    <div className="text-xs text-muted-foreground p-3">
                                      ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”ë¥¼ ìœ„í•´ ì²˜ìŒ {MAX_VULNERABILITIES_PER_PORT}ê°œì˜ ì·¨ì•½ì ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                                      ì „ì²´ ëª©ë¡ì€ ë¦¬í¬íŠ¸ ìƒì„± í›„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                    </div>
                                  )}
                                </Accordion>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </AccordionContent>
                </AccordionItem>
              );
            })}
          </Accordion>
        </CardContent>
        
        <CardFooter>
          <Button 
            className="w-full" 
            onClick={handleGenerateReport} 
            disabled={loading || isGeneratingReport}
          >
            {isGeneratingReport ? 'ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...' : 'ë¦¬í¬íŠ¸ ìƒì„±'}
          </Button>
        </CardFooter>
      </Card>
      
      {/* ë„¤íŠ¸ì›Œí¬ í† í´ë¡œì§€ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€ - í•„ìš”í•  ë•Œë§Œ ë Œë”ë§ */}
      {currentReport !== null && <NetworkTopology showAddReportButton={true} />}
    </>
  );
};

export default VulnerabilityResults; 